generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  name               String
  email              String              @unique
  passwordHash       String
  role               UserRole            @default(VENDEDOR)
  isActive           Boolean             @default(true)
  businessId         String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  cashClosings       CashClosing[]
  cashClosingsClosed CashClosing[]       @relation("ClosedBy")
  cashMovements      CashMovement[]
  cashRegisters      CashRegister[]
  clientActivityLogs ClientActivityLog[]
  clientPayments     ClientPayment[]
  purchases          Purchase[]
  refunds            Refund[]
  sales              Sale[]
  stockMovements     StockMovement[]
  business           Business?           @relation(fields: [businessId], references: [id])

  @@index([email])
  @@index([role])
  @@index([businessId])
  @@map("users")
}

model Business {
  id              String           @id @default(cuid())
  name            String
  email           String           @unique
  phone           String?
  address         String?
  taxId           String?
  logo            String?
  ownerId         String           @unique
  planType        PlanType         @default(BASICO)
  isDemo          Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  cashClosings    CashClosing[]
  clients         Client[]
  invoices        Invoice[]
  planBlockLogs   PlanBlockLog[]
  products        Product[]
  sales           Sale[]
  subscription    Subscription?
  subscriptionARS SubscriptionARS?
  users           User[]

  @@index([email])
  @@index([ownerId])
  @@index([planType])
  @@map("businesses")
}

model Subscription {
  id                   String             @id @default(cuid())
  businessId           String             @unique
  planType             PlanType
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  mpPreapprovalId      String?            @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  business             Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([mpPreapprovalId])
  @@map("subscriptions")
}

model Invoice {
  id              String    @id @default(cuid())
  businessId      String
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("ARS")
  status          String
  stripeInvoiceId String?   @unique
  mpPaymentId     String?   @unique
  invoiceNumber   String?
  invoiceUrl      String?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([stripeInvoiceId])
  @@index([mpPaymentId])
  @@map("invoices")
}

model SubscriptionPlan {
  id                 String            @id @default(cuid())
  name               String
  slug               String            @unique
  description        String?
  priceMonthly       Decimal           @db.Decimal(10, 2)
  priceYearly        Decimal           @db.Decimal(10, 2)
  setupFee           Decimal           @default(0) @db.Decimal(10, 2)
  maxUsers           Int?
  maxProducts        Int?
  maxSales           Int?
  features           Json              @default("[]")
  isActive           Boolean           @default(true)
  position           Int               @default(0)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  hasAPI             Boolean           @default(false)
  hasAdvancedReports Boolean           @default(false)
  hasCurrentAccounts Boolean           @default(false)
  hasIntegrations    Boolean           @default(false)
  isMostPopular      Boolean           @default(false)
  maxLocations       Int?
  supportLevel       String            @default("email")
  priceAdjustments   PriceAdjustment[]
  subscriptions      SubscriptionARS[]

  @@index([slug])
  @@index([isActive])
  @@map("subscription_plans")
}

model Addon {
  id                 String              @id @default(cuid())
  name               String
  slug               String              @unique
  description        String?
  priceMonthly       Decimal             @db.Decimal(10, 2)
  features           Json                @default("[]")
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  priceAdjustments   PriceAdjustment[]
  subscriptionAddons SubscriptionAddon[]

  @@index([slug])
  @@index([isActive])
  @@map("addons")
}

model SubscriptionARS {
  id                       String              @id @default(cuid())
  businessId               String              @unique
  planId                   String
  planTier                 PlanTier?
  status                   String              @default("pending")
  billingCycle             String              @default("monthly")
  currentPeriodStart       DateTime
  currentPeriodEnd         DateTime
  freeTrial                Boolean             @default(false)
  trialEndsAt              DateTime?
  setupFeePaid             Boolean             @default(false)
  setupFeeAmount           Decimal?            @db.Decimal(10, 2)
  setupFeePaidAt           DateTime?
  priceMonthly             Decimal             @db.Decimal(10, 2)
  priceYearly              Decimal?            @db.Decimal(10, 2)
  totalAddons              Decimal             @default(0) @db.Decimal(10, 2)
  totalMonthly             Decimal             @db.Decimal(10, 2)
  mercadopagoPreapprovalId String?
  cancelAtPeriodEnd        Boolean             @default(false)
  canceledAt               DateTime?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  payments                 Payment[]
  subscriptionAddons       SubscriptionAddon[]
  business                 Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  plan                     SubscriptionPlan    @relation(fields: [planId], references: [id])

  @@index([businessId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions_ars")
}

model SubscriptionAddon {
  id             String          @id @default(cuid())
  subscriptionId String
  addonId        String
  price          Decimal         @db.Decimal(10, 2)
  activatedAt    DateTime        @default(now())
  deactivatedAt  DateTime?
  isActive       Boolean         @default(true)
  addon          Addon           @relation(fields: [addonId], references: [id])
  subscription   SubscriptionARS @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([addonId])
  @@map("subscription_addons")
}

model Payment {
  id                   String          @id @default(cuid())
  subscriptionId       String
  amount               Decimal         @db.Decimal(10, 2)
  currency             String          @default("ARS")
  type                 String
  method               String
  status               String          @default("pending")
  mercadopagoPaymentId String?
  mercadopagoStatus    String?
  transferReceipt      String?
  transferProof        String?
  transferReference    String?
  adminNotes           String?
  invoiceNumber        String?
  paidAt               DateTime?
  dueDate              DateTime?
  notes                String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  subscription         SubscriptionARS @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([mercadopagoPaymentId])
  @@map("payments")
}

model PriceAdjustment {
  id               String            @id @default(cuid())
  planId           String?
  addonId          String?
  previousPrice    Decimal           @db.Decimal(10, 2)
  newPrice         Decimal           @db.Decimal(10, 2)
  percentage       Decimal?          @db.Decimal(5, 2)
  reason           String
  ipcValue         Decimal?          @db.Decimal(5, 2)
  appliedAt        DateTime          @default(now())
  appliedBy        String
  notificationSent Boolean           @default(false)
  createdAt        DateTime          @default(now())
  addon            Addon?            @relation(fields: [addonId], references: [id])
  plan             SubscriptionPlan? @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([addonId])
  @@map("price_adjustments")
}

model WebhookLog {
  id        String   @id @default(cuid())
  type      String
  source    String   @default("mercadopago")
  payload   Json
  status    String   @default("received")
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([source])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_logs")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@index([name])
  @@map("categories")
}

model Product {
  id             String           @id @default(cuid())
  businessId     String
  name           String
  sku            String
  barcode        String?
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  wholesalePrice Decimal?         @db.Decimal(10, 2)
  cost           Decimal          @db.Decimal(10, 2)
  stock          Int              @default(0)
  minStock       Int              @default(0)
  maxStock       Int?
  categoryId     String?
  image          String?
  images         String[]
  unit           String?          @default("unidad")
  taxRate        Decimal          @default(21) @db.Decimal(5, 2)
  hasVariants    Boolean          @default(false)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  variants       ProductVariant[]
  business       Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id])
  purchaseItems  PurchaseItem[]
  refundItems    RefundItem[]
  saleItems      SaleItem[]
  stockMovements StockMovement[]

  @@unique([businessId, sku])
  @@unique([businessId, barcode])
  @@index([businessId])
  @@index([businessId, isActive])
  @@index([businessId, categoryId])
  @@index([name])
  @@map("products")
}

model Sale {
  id              String        @id @default(cuid())
  userId          String
  clientId        String?
  cashClosingId   String?
  total           Decimal       @db.Decimal(10, 2)
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  discountType    String?
  paymentMethod   PaymentMethod
  hasMixedPayment Boolean       @default(false)
  status          SaleStatus    @default(COMPLETADO)
  notes           String?
  ticketNumber    Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  businessId      String
  cashRegisterId  String?
  refunds         Refund[]
  saleItems       SaleItem[]
  salePayments    SalePayment[]
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  cashClosing     CashClosing?  @relation(fields: [cashClosingId], references: [id])
  cashRegister    CashRegister? @relation(fields: [cashRegisterId], references: [id])
  client          Client?       @relation(fields: [clientId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([businessId])
  @@index([userId])
  @@index([clientId])
  @@index([cashClosingId])
  @@index([cashRegisterId])
  @@index([createdAt])
  @@index([status])
  @@map("sales")
}

model SaleItem {
  id          String       @id @default(cuid())
  saleId      String
  productId   String
  quantity    Int
  price       Decimal      @db.Decimal(10, 2)
  subtotal    Decimal      @db.Decimal(10, 2)
  createdAt   DateTime     @default(now())
  product     Product      @relation(fields: [productId], references: [id])
  sale        Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  refundItems RefundItem[]

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Refund {
  id           String       @id @default(cuid())
  saleId       String
  userId       String
  type         RefundType
  reason       String
  refundAmount Decimal      @db.Decimal(10, 2)
  restockItems Boolean      @default(true)
  notes        String?
  createdAt    DateTime     @default(now())
  items        RefundItem[]
  sale         Sale         @relation(fields: [saleId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([saleId])
  @@index([userId])
  @@index([createdAt])
  @@map("refunds")
}

model RefundItem {
  id         String   @id @default(cuid())
  refundId   String
  saleItemId String
  productId  String
  quantity   Int
  price      Decimal  @db.Decimal(10, 2)
  subtotal   Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id])
  refund     Refund   @relation(fields: [refundId], references: [id], onDelete: Cascade)
  saleItem   SaleItem @relation(fields: [saleItemId], references: [id])

  @@index([refundId])
  @@index([saleItemId])
  @@index([productId])
  @@map("refund_items")
}

model Client {
  id               String              @id @default(cuid())
  name             String
  phone            String?
  email            String?             @unique
  address          String?
  taxId            String?
  notes            String?
  creditLimit      Decimal             @default(0) @db.Decimal(10, 2)
  currentDebt      Decimal             @default(0) @db.Decimal(10, 2)
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  businessId       String
  lastPurchaseAt   DateTime?
  status           ClientStatus        @default(ACTIVE)
  tags             String[]            @default([])
  hasCreditAccount Boolean             @default(false)
  activityLogs     ClientActivityLog[]
  payments         ClientPayment[]
  business         Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sales            Sale[]

  @@index([name])
  @@index([email])
  @@index([phone])
  @@index([businessId])
  @@index([status])
  @@index([lastPurchaseAt])
  @@map("clients")
}

model ClientPayment {
  id            String   @id @default(cuid())
  clientId      String
  amount        Decimal  @db.Decimal(10, 2)
  paymentMethod String
  reference     String?
  notes         String?
  userId        String
  createdAt     DateTime @default(now())
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])

  @@index([clientId])
  @@index([createdAt])
  @@map("client_payments")
}

model ClientActivityLog {
  id          String   @id @default(cuid())
  clientId    String
  action      String
  description String
  metadata    Json?
  userId      String?
  ipAddress   String?
  createdAt   DateTime @default(now())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([clientId])
  @@index([createdAt])
  @@index([action])
  @@map("client_activity_logs")
}

model Supplier {
  id        String     @id @default(cuid())
  name      String
  phone     String?
  email     String?    @unique
  address   String?
  taxId     String?
  notes     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  purchases Purchase[]

  @@index([name])
  @@index([email])
  @@map("suppliers")
}

model Purchase {
  id            String         @id @default(cuid())
  supplierId    String
  userId        String
  total         Decimal        @db.Decimal(10, 2)
  subtotal      Decimal        @db.Decimal(10, 2)
  tax           Decimal        @default(0) @db.Decimal(10, 2)
  invoiceNum    String?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  purchaseItems PurchaseItem[]
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  user          User           @relation(fields: [userId], references: [id])

  @@index([supplierId])
  @@index([userId])
  @@index([createdAt])
  @@map("purchases")
}

model PurchaseItem {
  id         String   @id @default(cuid())
  purchaseId String
  productId  String
  quantity   Int
  cost       Decimal  @db.Decimal(10, 2)
  subtotal   Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id])
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
}

model CashMovement {
  id             String           @id @default(cuid())
  type           CashMovementType
  amount         Decimal          @db.Decimal(10, 2)
  description    String?
  reference      String?
  userId         String
  createdAt      DateTime         @default(now())
  businessId     String
  cashRegisterId String?
  isAnulado      Boolean          @default(false)
  cashRegister   CashRegister?    @relation(fields: [cashRegisterId], references: [id])
  user           User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([businessId])
  @@index([cashRegisterId])
  @@index([type])
  @@index([createdAt])
  @@map("cash_movements")
}

model CashRegister {
  id                     String             @id @default(cuid())
  businessId             String
  userId                 String
  openedAt               DateTime           @default(now())
  closedAt               DateTime?
  status                 CashRegisterStatus @default(OPEN)
  openingAmount          Decimal            @db.Decimal(10, 2)
  closingAmount          Decimal?           @db.Decimal(10, 2)
  expectedAmount         Decimal?           @db.Decimal(10, 2)
  difference             Decimal?           @db.Decimal(10, 2)
  totalCash              Decimal            @default(0) @db.Decimal(10, 2)
  totalCard              Decimal            @default(0) @db.Decimal(10, 2)
  totalTransfer          Decimal            @default(0) @db.Decimal(10, 2)
  totalOther             Decimal            @default(0) @db.Decimal(10, 2)
  totalMixedPayments     Decimal            @default(0) @db.Decimal(10, 2)
  totalRefunds           Decimal            @default(0) @db.Decimal(10, 2)
  totalInvoiced          Decimal            @default(0) @db.Decimal(10, 2)
  totalNotInvoiced       Decimal            @default(0) @db.Decimal(10, 2)
  notes                  String?
  salesCount             Int                @default(0)
  refundsCount           Int                @default(0)
  closedBy               String?
  requiresAuthorization  Boolean            @default(false)
  authorizedBy           String?
  authorizedAt           DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  cashMovements          CashMovement[]
  user                   User               @relation(fields: [userId], references: [id])
  sales                  Sale[]

  @@index([businessId])
  @@index([userId])
  @@index([status])
  @@index([openedAt])
  @@index([closedAt])
  @@index([closedBy])
  @@map("cash_registers")
}

model CashClosing {
  id                 String    @id @default(cuid())
  number             Int       @default(autoincrement())
  from               DateTime
  to                 DateTime
  totalCash          Decimal   @db.Decimal(10, 2)
  totalCard          Decimal   @db.Decimal(10, 2)
  totalTransfer      Decimal   @db.Decimal(10, 2)
  totalGeneral       Decimal   @db.Decimal(10, 2)
  totalMixedPayments Decimal   @default(0) @db.Decimal(10, 2)
  totalRefunds       Decimal   @default(0) @db.Decimal(10, 2)
  totalInvoiced      Decimal   @default(0) @db.Decimal(10, 2)
  totalNotInvoiced   Decimal   @default(0) @db.Decimal(10, 2)
  salesCount         Int       @default(0)
  refundsCount       Int       @default(0)
  cashCounted        Decimal?  @db.Decimal(10, 2)
  cashExpected       Decimal?  @db.Decimal(10, 2)
  cashDifference     Decimal   @default(0) @db.Decimal(10, 2)
  notes              String?
  responsibleId      String
  closedById         String?
  businessId         String?
  createdAt          DateTime  @default(now())
  responsible        User      @relation(fields: [responsibleId], references: [id])
  closedBy           User?     @relation("ClosedBy", fields: [closedById], references: [id])
  business           Business? @relation(fields: [businessId], references: [id])
  sales              Sale[]

  @@index([responsibleId])
  @@index([closedById])
  @@index([businessId])
  @@index([from])
  @@index([to])
  @@index([number])
  @@index([createdAt])
  @@map("cash_closings")
}

model ProductVariant {
  id         String   @id @default(cuid())
  productId  String
  name       String
  sku        String   @unique
  barcode    String?  @unique
  attributes Json
  price      Decimal  @db.Decimal(10, 2)
  cost       Decimal  @db.Decimal(10, 2)
  stock      Int      @default(0)
  image      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model StockMovement {
  id        String            @id @default(cuid())
  productId String
  type      StockMovementType
  quantity  Int
  reason    String?
  reference String?
  userId    String
  createdAt DateTime          @default(now())
  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
  @@index([createdAt])
  @@map("stock_movements")
}

model SalePayment {
  id            String        @id @default(cuid())
  saleId        String
  paymentMethod PaymentMethod
  amount        Decimal       @db.Decimal(10, 2)
  reference     String?
  createdAt     DateTime      @default(now())
  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@map("sale_payments")
}

model PlanBlockLog {
  id         String   @id @default(cuid())
  businessId String
  type       String
  reason     String
  metadata   Json?
  createdAt  DateTime @default(now())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
  @@map("plan_block_logs")
}

enum UserRole {
  ADMIN
  VENDEDOR
  GERENTE
  SUPERVISOR
  OWNER
}

enum PlanType {
  FREE
  BASICO
  STARTER
  PRO
  ENTERPRISE
  FULL
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum PaymentMethod {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  QR
  CUENTA_CORRIENTE
  MIXTO
  OTRO
}

enum SaleStatus {
  COMPLETADO
  PENDIENTE
  CANCELADO
  REEMBOLSADO
  PARCIALMENTE_REEMBOLSADO
}

enum RefundType {
  TOTAL
  PARCIAL
}

enum ClientStatus {
  ACTIVE
  DELINQUENT
  INACTIVE
  BLOCKED
}

enum CashMovementType {
  APERTURA
  CIERRE
  INGRESO
  EGRESO
  VENTA
  SALIDA
}

enum CashRegisterStatus {
  OPEN
  CLOSED
}

enum StockMovementType {
  ENTRADA
  SALIDA
  AJUSTE
  TRANSFERENCIA
}

enum PlanTier {
  EMPRENDEDOR
  PYME
  FULL
}

enum PaymentPeriod {
  MENSUAL
  ANUAL
  UNICO
}

enum PaymentStatus {
  PENDIENTE
  PAGADO
  RECHAZADO
  VENCIDO
  CANCELADO
}
